<?php

/**
 * This file is part of the Cubiche package.
 *
 * Copyright (c) Cubiche
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
namespace Cubiche\Core\EventDispatcher\Tests\Units;

use Cubiche\Core\Bus\Message\Resolver\ClassBasedNameResolver;
use Cubiche\Core\EventDispatcher\Event;
use Cubiche\Core\EventDispatcher\EventDispatcher;
use Cubiche\Core\EventDispatcher\Tests\Fixtures\LoginUserEvent;
use Cubiche\Core\EventDispatcher\Tests\Fixtures\LoginUserEventListener;
use Cubiche\Core\EventDispatcher\Tests\Fixtures\UserEventSubscriber;

/**
 * EventDispatcher class.
 *
 * Generated by TestGenerator on 2016-04-11 at 15:18:25.
 */
class EventDispatcherTests extends TestCase
{
    /**
     * @return EventDispatcher
     */
    public function createEventDispatcher()
    {
        return new EventDispatcher(new ClassBasedNameResolver());
    }

    /**
     * Test Dispatch method.
     */
    public function testDispatch()
    {
        // dispatch with one callable listener
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($counter = 0)
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                ++$counter;
            }))
            ->when($dispatcher->dispatch(new LoginUserEvent('ivan@cubiche.com')))
            ->then()
                ->integer($counter)
                    ->isEqualTo(1)
        ;

        // dispatch with many callable listener
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($counter = 0)
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                ++$counter;
            }))
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                ++$counter;
            }))
            ->when($dispatcher->dispatch(new LoginUserEvent('ivan@cubiche.com')))
            ->then()
                ->integer($counter)
                    ->isEqualTo(2)
        ;

        // dispatch with many callable listener but stopped the event propagation
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($counter = 0)
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                ++$counter;
                $event->stopPropagation();
            }))
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                ++$counter;
            }))
            ->when($dispatcher->dispatch(new LoginUserEvent('ivan@cubiche.com')))
            ->then()
                ->integer($counter)
                    ->isEqualTo(1)
        ;

        // dispatch with many callable listener and priority
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($counter = 3)
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                $counter = $counter * 5;
            }, 50))
            ->and($dispatcher->addListener(LoginUserEvent::class, function (Event $event) use (&$counter) {
                $counter = $counter + 2;
            }, 100))
            ->when($dispatcher->dispatch(new LoginUserEvent('ivan@cubiche.com')))
            ->then()
                ->integer($counter)
                    ->isEqualTo(25)
        ;

        // dispatch with many listener class or callable
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($event = new LoginUserEvent('ivan@cubiche.com'))
            ->and($dispatcher->addListener(LoginUserEvent::class, array(new LoginUserEventListener(), 'onLogin')))
            ->and($dispatcher->addListener(LoginUserEvent::class, function (LoginUserEvent $event) {
                $this
                    ->string($event->email())
                        ->isEqualTo('info@cubiche.org')
                ;

                $event->setEmail('fake@email.com');
            }))
            ->when($dispatcher->dispatch($event))
            ->then()
                ->string($event->email())
                    ->isEqualTo('fake@email.com')
        ;
    }

    /**
     * Test listenerPriority method.
     */
    public function testListenerPriority()
    {
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($listener1 = array(new LoginUserEventListener(), 'onLogin'))
            ->and($listener2 = function (Event $event) {
                return $event->messageName();
            })
            ->and($listener3 = function (Event $event) {

            })
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener1, 100))
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener2, 50))
            ->and($dispatcher->addListener('event.bar', $listener3))
            ->then()
                ->variable($dispatcher->listenerPriority('event.unknow', $listener1))
                    ->isNull()
                ->variable($dispatcher->listenerPriority(LoginUserEvent::class, $listener3))
                    ->isNull()
                ->integer($dispatcher->listenerPriority(LoginUserEvent::class, $listener1))
                    ->isEqualTo(100)
                ->integer($dispatcher->listenerPriority(LoginUserEvent::class, $listener2))
                    ->isEqualTo(50)
        ;
    }

    /**
     * Test HasListeners method.
     */
    public function testHasListeners()
    {
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($listener1 = array(new LoginUserEventListener(), 'onLogin'))
            ->and($listener2 = function (Event $event) {
                return $event->messageName();
            })
            ->and($listener3 = function (Event $event) {

            })
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener1, 100))
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener2, 50))
            ->and($dispatcher->addListener('event.bar', $listener3))
            ->then()
                ->boolean($dispatcher->hasEventListeners('event.unknow'))
                    ->isFalse()
                ->boolean($dispatcher->hasEventListeners(LoginUserEvent::class))
                    ->isTrue()
                ->boolean($dispatcher->hasListeners())
                    ->isTrue()
        ;
    }

    /**
     * Test RemoveListener method.
     */
    public function testRemoveListener()
    {
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($listener1 = array(new LoginUserEventListener(), 'onLogin'))
            ->and($listener2 = function (Event $event) {
                return $event->messageName();
            })
            ->and($listener3 = function (Event $event) {

            })
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener1, 100))
            ->and($dispatcher->addListener(LoginUserEvent::class, $listener2, 50))
            ->and($dispatcher->addListener('event.bar', $listener3))
            ->then()
                ->boolean($dispatcher->hasListeners(LoginUserEvent::class))
                    ->isTrue()
                ->and()
                ->when($dispatcher->removeListener(LoginUserEvent::class, $listener1))
                ->then()
                    ->boolean($dispatcher->hasListeners(LoginUserEvent::class))
                        ->isTrue()
                ->and()
                ->when($dispatcher->removeListener('event.unknow', $listener2))
                ->when($dispatcher->removeListener(LoginUserEvent::class, $listener2))
                ->then()
                    ->boolean($dispatcher->hasEventListeners(LoginUserEvent::class))
                        ->isFalse()
        ;
    }

    /**
     * Test AddSubscriber method.
     */
    public function testAddSubscriber()
    {
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($dispatcher->addSubscriber(new UserEventSubscriber()))
            ->then()
                ->boolean($dispatcher->hasListeners())
                    ->isTrue()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::FOO_EVENT))
                    ->isTrue()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::BAR_EVENT))
                    ->isTrue()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::USER_LOGIN))
                    ->isTrue()
        ;
    }

    /**
     * Test RemoveSubscriber method.
     */
    public function testRemoveSubscriber()
    {
        $this
            ->given($dispatcher = $this->createEventDispatcher())
            ->and($subscriber = new UserEventSubscriber())
            ->and($dispatcher->addSubscriber($subscriber))
            ->then()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::FOO_EVENT))
                    ->isTrue()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::BAR_EVENT))
                    ->isTrue()
                ->boolean($dispatcher->hasListeners(UserEventSubscriber::USER_LOGIN))
                    ->isTrue()
                ->and()
                ->when($dispatcher->removeSubscriber($subscriber))
                ->then()
                    ->boolean($dispatcher->hasListeners(UserEventSubscriber::FOO_EVENT))
                        ->isFalse()
                    ->boolean($dispatcher->hasListeners(UserEventSubscriber::BAR_EVENT))
                        ->isFalse()
                    ->boolean($dispatcher->hasListeners(UserEventSubscriber::USER_LOGIN))
                        ->isFalse()
        ;
    }
}
