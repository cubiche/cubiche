<?php

/**
 * This file is part of the Cubiche/EventSourcing component.
 *
 * Copyright (c) Cubiche
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
namespace Cubiche\Domain\EventSourcing\Tests\Units\Migrations\Cli;

use Cubiche\Domain\EventSourcing\Migrations\Cli\Command\MigrationsGenerateCommand;
use Cubiche\Domain\EventSourcing\Migrations\Cli\MigrationsService;
use Cubiche\Domain\EventSourcing\Migrations\MigrationInterface;
use Cubiche\Domain\EventSourcing\Migrations\Migrator;
use Cubiche\Domain\EventSourcing\Tests\Fixtures\PostEventSourced;
use Cubiche\Domain\EventSourcing\Tests\Units\TestCase;
use Cubiche\Domain\EventSourcing\Versioning\Version;
use Cubiche\Domain\EventSourcing\Versioning\VersionIncrementType;
use Cubiche\Domain\EventSourcing\Versioning\VersionManager;
use Cubiche\Tests\Generator\ClassUtils;
use Webmozart\Console\Api\IO\Input;
use Webmozart\Console\Api\IO\IO;
use Webmozart\Console\Api\IO\Output;
use Webmozart\Console\IO\InputStream\NullInputStream;
use Webmozart\Console\IO\OutputStream\BufferedOutputStream;

/**
 * MigrationsServiceTests class.
 *
 * Generated by TestGenerator on 2016-08-10 at 10:18:25.
 */
class MigrationsServiceTests extends TestCase
{
    /**
     * @var BufferedOutputStream
     */
    protected $output;

    /**
     * @return MigrationsService
     */
    protected function createService()
    {
        return new MigrationsService(new Migrator($this->getClassMetadataFactory(), $this->migrationsDirectory));
    }

    /**
     * @param string $filename
     *
     * @return MigrationInterface
     */
    protected function getMigratorClass($filename)
    {
        require_once $filename;
        $classes = ClassUtils::getClassesInFile($filename);
        foreach ($classes as $className) {
            $reflector = new \ReflectionClass($className);

            return $reflector->newInstanceWithoutConstructor();
        }

        return;
    }

    /**
     * @return IO
     */
    protected function getIO()
    {
        $this->output = new BufferedOutputStream();

        return new IO(
            new Input(new NullInputStream()),
            new Output($this->output),
            new Output(new BufferedOutputStream())
        );
    }

    /**
     * Test MigrationsGenerate method.
     */
    public function testMigrationsGenerateForAggregateClass()
    {
        $this
            ->given($service = $this->createService())
            ->and($command = new MigrationsGenerateCommand(null, PostEventSourced::class))
            ->and($command->setIo($this->getIO()))
            ->and($version = VersionManager::versionOfClass(PostEventSourced::class))
            ->and($version->increment(VersionIncrementType::MINOR()))
            ->and($migrationFilename = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->and($migrationClass = $this->getMigratorClass($migrationFilename))
            ->then()
                ->boolean(file_exists($migrationFilename))
                    ->isTrue()
                ->string($migrationClass->aggregateClassName())
                    ->isEqualTo(PostEventSourced::class)
                ->object($migrationClass->migrationType())
                    ->isEqualTo(VersionIncrementType::MINOR())
                ->string($this->output->fetch())
                    ->contains('Generating migration')
                    ->contains('successfully generated')
                ->and()
                ->when($service->migrationsGenerate($command))
                ->then()
                    ->string($this->output->fetch())
                        ->contains('already exists.')
        ;

        $this
            ->given($service = $this->createService())
            ->and($command = new MigrationsGenerateCommand(null, __DIR__.'/../../../Fixtures/PostEventSourced.php'))
            ->and($command->setIo($this->getIO()))
            ->and($version = VersionManager::versionOfClass(PostEventSourced::class))
            ->and($version->increment(VersionIncrementType::MINOR()))
            ->and($migrationFilename = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->and($migrationClass = $this->getMigratorClass($migrationFilename))
            ->then()
                ->boolean(file_exists($migrationFilename))
                    ->isTrue()
                ->string($migrationClass->aggregateClassName())
                    ->isEqualTo(PostEventSourced::class)
                ->object($migrationClass->migrationType())
                    ->isEqualTo(VersionIncrementType::MINOR())
        ;

        $this
            ->given($service = $this->createService())
            ->and(
                $command = new MigrationsGenerateCommand(
                    null,
                    __DIR__.'/../../../../Migrations/MigrationInterface.php'
                )
            )
            ->and($command->setIo($this->getIO()))
            ->and($version = VersionManager::versionOfClass(PostEventSourced::class))
            ->and($migrationFilename = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->then()
                ->boolean(file_exists($migrationFilename))
                    ->isFalse()
                ->string($this->output->fetch())
                    ->contains('Invalid class name')
        ;

        $this
            ->given($service = $this->createService())
            ->and($command = new MigrationsGenerateCommand())
            ->and($command->setIo($this->getIO()))
            ->and($version = VersionManager::versionOfClass(PostEventSourced::class))
            ->and($migrationFilename = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->then()
                ->boolean(file_exists($migrationFilename))
                    ->isFalse()
                ->string($this->output->fetch())
                    ->contains('A version number or an aggregate class name is needed.')

        ;
    }

    /**
     * Test MigrationsGenerate method.
     */
    public function testMigrationsGenerateForProjectVersion()
    {
        require_once __DIR__.'/../../../Fixtures/BlogEventSourced.php';

        $this
            ->given($service = $this->createService())
            ->and($command = new MigrationsGenerateCommand('2.5.0'))
            ->and($command->setIo($this->getIO()))
            ->and($version = Version::fromString('2.5.0'))
            ->and($migrationFilename1 = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->and($migrationFilename2 = $this->getMigratorFileName(\BlogEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->and($migrationClass1 = $this->getMigratorClass($migrationFilename1))
            ->and($migrationClass2 = $this->getMigratorClass($migrationFilename2))
            ->then()
                ->boolean(file_exists($migrationFilename1))
                    ->isTrue()
                ->boolean(file_exists($migrationFilename2))
                    ->isTrue()
                ->string($migrationClass1->aggregateClassName())
                    ->isEqualTo(PostEventSourced::class)
                ->string($migrationClass2->aggregateClassName())
                    ->isEqualTo(\BlogEventSourced::class)
                ->object($migrationClass1->migrationType())
                    ->isEqualTo(VersionIncrementType::MAJOR())
                ->object($migrationClass2->migrationType())
                    ->isEqualTo(VersionIncrementType::MAJOR())
                ->string($this->output->fetch())
                    ->contains('Generating project migration to version')
                    ->contains('successfully generated')
                ->and()
                ->when($service->migrationsGenerate($command))
                ->then()
                    ->string($this->output->fetch())
                        ->contains('A project migration with version '.$version->__toString().' already exists.')
        ;

        $this
            ->given($service = $this->createService())
            ->and($command = new MigrationsGenerateCommand('3.2.6'))
            ->and($command->setIo($this->getIO()))
            ->and($version = Version::fromString('3.2.6'))
            ->and($migrationFilename1 = $this->getMigratorFileName(PostEventSourced::class, $version))
            ->and($migrationFilename2 = $this->getMigratorFileName(\BlogEventSourced::class, $version))
            ->when($service->migrationsGenerate($command))
            ->then()
                ->boolean(file_exists($migrationFilename1))
                    ->isFalse()
                ->boolean(file_exists($migrationFilename2))
                    ->isFalse()
                ->string($this->output->fetch())
                    ->contains('A version number must be a minor (x.x.0) or a major (x.0.0) version.')
        ;
    }

    /**
     * Test MigrationsMigrate method.
     */
    public function testMigrationsMigrate()
    {
        // todo: Implement testMigrationsMigrate().
    }

    /**
     * Test MigrationsStatus method.
     */
    public function testMigrationsStatus()
    {
        // todo: Implement testMigrationsStatus().
    }
}
